// (c) Archy Sharp
// All right reserved

(function(){function t(t,i){var r=this;this.container=t;this.items=t.find(">*").on("click",function(){var t=$(this),i,u;t.hasClass(n)||(i=r.items.filter("."+n).removeClass(n),u=i.attr("data-type"),t.addClass(n),r.container.trigger("change",{prev:u,next:t.attr("data-type")}))});typeof i.selected=="number"?this.items.eq(i.selected).addClass(n):typeof i.selected=="string"&&this.items.filter("[data-type="+i.selected+"]").addClass(n)}var i={selected:0},n="current";t.prototype.val=function(t){if(t!==undefined){typeof t=="string"?this.items.filter("[data-type="+t+"]").click():typeof t=="number"&&this.items.eq(t).click();return}return this.items.filter("."+n).attr("data-type")};$.fn.extraSelector=function(n,r){if(n==="value"||n==="selected"){var u=this.eq(0).data("extra-selector");if(!u)return;if(r!==undefined){u.val(r);return}return u.val()}return n=$.extend({},i,n),this.each(function(i,r){var f=$(r),u=f.data("extra-selector");u||(u=new t(f,n),f.data("extra-selector",u))})}})(jQuery),function(n){function s(i){var u=n.Deferred(),f={},e=i.map(r).every(function(n){return f[n]=new Store(n),!f[n].findAll().length});return e?(n.getJSON("./primary-data.json").done(function(n){_.each(n,function(n,i){_.each(n,function(n,r){var u=new t({id:n.id,index:r,type:n.type,name:n.name});f[i].create(u)})});u.resolve()}).fail(function(){u.reject()}),u):u.resolve()}function i(){this.index=[0]}function r(n){return n.toLowerCase().replace(" ","-")}var u=Backbone.Model.extend({defaults:{title:"Dashboard"}}),t=Backbone.Model.extend({defaults:{id:0,index:0,name:"",type:"task"},initialize:function(){this.on("change",function(){this.save()})}}),f=Backbone.View.extend({render:function(){return this.setElement(this.options.templates.column(this.model.attributes)),this.content=this.$(".content").sortable({connectWith:".column .content",cancel:".unsortable"}),this.editorWrap=this.$(".editor-wrap"),this.btnNew=this.editorWrap.find(".btn-new"),this.editor=this.editorWrap.find(".editor"),this.type=this.editor.find(".extra-selector-wrap").html(this.options.templates.extraSelector()).find(".extra-selector").extraSelector(),this.textarea=this.editor.find("textarea").autosize(),this.btnOk=this.editor.find(".editor .btn-ok"),this.collection.each(function(n){this.addTaskToView(n)},this),this.$el},events:{"click .btn-new":"openNewTaskForm","click .btn-ok":"tryNewTaskBySubmit","blur .editor textarea":"tryFinishNewTask","keydown .editor textarea":"tryNewTask",sortstart:"sortStart",sortstop:"sortStop",sortremove:"sortRemove",sortreceive:"sortReceive",sortupdate:"sortUpdate"},initialize:function(n,t){this.options=t},openNewTaskForm:function(){this.editor.removeClass("hidden");this.btnNew.addClass("hidden");this.textarea.focus()},tryFinishNewTask:function(){this.textarea.val().length||(this.editor.addClass("hidden"),this.btnNew.removeClass("hidden"))},tryNewTaskBySubmit:function(){var n=this.textarea.val();n.length&&(this.editor.addClass("hidden"),this.btnNew.removeClass("hidden"),this.addTaskToModel(_.escape(n)),this.textarea.val(""))},tryNewTask:function(n){n.keyCode===13&&n.shiftKey&&this.tryNewTaskBySubmit()},addTaskToModel:function(n){var r=this.options.taskIndexer.next(),i=new t({id:r,index:this.collection.models.length,name:n,type:this.type.extraSelector("value")});this.addTaskToView(i);this.collection.add(i)},addTaskToView:function(n){this.options.taskIndexer.insert(n.get("id"));this.content.append(new e({model:n},this.options).render())},sortStart:function(n,t){var i=t.item.index();t.item.data("sortable-prev-index",{index:i,model:this.collection.at(i),update:0})},sortStop:function(n,t){var i=t.item.data("sortable-prev-index");i.update===1&&this.collection.moveTo(i.index,t.item.index());t.item.removeData("sortable-prev-index")},sortRemove:function(n,t){var i=t.item.data("sortable-prev-index");this.collection.remove(i.model)},sortReceive:function(n,t){var i=t.item.data("sortable-prev-index");this.collection.add(i.model,{at:t.item.index()})},sortUpdate:function(n,t){var i=t.item.data("sortable-prev-index");i.update++}}),e=Backbone.View.extend({render:function(){return this.setElement(this.options.templates.item(this.model.attributes)),this.name=this.$(".name"),this.textarea=this.$("textarea").autosize(),this.type=this.$(".extra-selector-wrap").html(this.options.templates.extraSelector()).find(".extra-selector").extraSelector({selected:this.model.get("type")}),this.$el},initialize:function(n,t){this.options=t},events:{"click .remove":"removeTask","dblclick .name":"editName","blur textarea":"saveName","change .extra-selector":"typeUpdate","keydown textarea":"trySaveName"},trySaveName:function(n){n.keyCode===13&&n.shiftKey&&this.saveName()},removeTask:function(){this.options.taskIndexer.remove(this.model.id);this.model.destroy();this.remove()},typeUpdate:function(n,t){this.model.set("type",t.next);this.$el.removeClass(t.prev).addClass(t.next)},editName:function(){this.name.addClass("hidden");this.textarea.removeClass("hidden").focus().val(_.unescape(this.name.html())).trigger("autosize.resize");this.$el.addClass("unsortable")},saveName:function(){this.$el.removeClass("unsortable");var n=_.escape(this.textarea.val());if(!n.length){this.removeTask();return}this.name.html(n).removeClass("hidden");this.textarea.addClass("hidden");this.model.set("name",n)}}),o=Backbone.Collection.extend({model:t,initialize:function(n,t){this.localStorage=new Store(t.key);this.fetch();this.on("add",function(n){n.save();this.normalizeIndexes()});this.on("remove",function(n){n.destroy();this.normalizeIndexes()})},moveTo:function(n,t){n!==t&&(this.models.splice(t,0,this.models.splice(n,1)[0]),this.normalizeIndexes())},normalizeIndexes:function(){this.each(function(n,t){n.set("index",t)})},comparator:function(n){return n.get("index")}});i.prototype={insert:function(n){this.index[n]=!0},remove:function(n){this.index[n]=!1;for(var t=this.index.length-1;t&&!this.index[t];t--)this.index.pop()},next:function(){return this.index.length}};n(function(){var e=n(".main-wrap"),t=["To Do","In Progress","Done"],h={taskIndexer:new i,templates:{column:_.template(n("#column-template").html()),item:_.template(n("#item-template").html()),extraSelector:_.template(n("#extra-selector-template").html())}};s(t).done(function(){n.each(t,function(n,t){var i=new o(null,{key:r(t)}),s=new u({title:t}),c=new f({model:s,collection:i},h);e.append(c.render())})}).fail(function(){alert("Unable to load initial data! Please check the connection.")})})}(jQuery)